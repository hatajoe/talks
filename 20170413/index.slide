dev-cloverlab/harbor
Umeda.go #1
13 Apr 2017
Tags: libcompose, docker

Yusuke Hatanaka
@hatajoe

* Topic

- ãƒ—ãƒ«ãƒªã‚¯å‹•ä½œç’°å¢ƒã‚’è‡ªå‹•æ§‹ç¯‰ã™ã‚‹è©±

* Intro

- ãƒ—ãƒ«ãƒªã‚¯ã®å‹•ä½œç’°å¢ƒãŒæ¬²ã—ã„ã‘ã©é¢å€’
- harborä½¿ã†ã¨ãƒ¬ãƒã‚¸ãƒˆãƒªã¸pushã—ãŸãƒ–ãƒ©ãƒ³ãƒã®å‹•ä½œç’°å¢ƒãŒå¾—ã‚‰ã‚Œã‚‹
- ğŸ‘¨ å®Ÿéš›ã«ä½¿ã†ã«ã¯Jenkinsãªã©ã®CIãƒ„ãƒ¼ãƒ«ã¨çµ„ã¿åˆã‚ã›ãªã„ã¨å³ã—ã„

* Me

.image hatajoe.png _ 300

- [[https://github.com/hatajoe][hatajoe]] GitHub
- [[https://twitter.com/hatajoe][@hatajoe]] Twitter
- [[https://kug2.connpass.com/][#kug2]] [[https://gglt.connpass.com/][#gglt]]
- working at Clover Lab.,inc.

* dev-cloverlab/harbor

[[https://github.com/dev-cloverlab/harbor][dev-cloverlab/harbor: harbor is API server manages the docker containers]]
harborã®ç®¡ç†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®docker-compose.ymlã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã ã‘

ç‰¹å¾´

- Goè£½ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ¼ãƒ³APIã‚µãƒ¼ãƒãƒ¼
- ã‚³ãƒ³ãƒ†ãƒŠæ“ä½œã«libcomposeã‚’ä½¿ç”¨
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«levelDBã‚’æ¡ç”¨(å˜ã«ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã§å‹•ã‹ã—ãŸã‹ã£ãŸã ã‘)

* Demo

* æº–å‚™ã¨è§£èª¬

- ãƒ¬ãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã«docker-compose.yml
- ä»Šå›ã®ãƒ‡ãƒ¢ã¯ä»¥ä¸‹ã®æ§‹æˆ

    % tree
    .
    â”œâ”€â”€ docker-compose.yml
    â””â”€â”€ public
        â””â”€â”€ index.html
    
    1 directory, 2 files

* æº–å‚™ã¨è§£èª¬

docker-compose.yml

    nginx:
      image: nginx
      ports:
       - "${PORT1}:80"
      volumes:
        - ./public/:/usr/share/nginx/html/

public/index.html

    Hello, World!

* æº–å‚™ã¨è§£èª¬

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’Jenkinsã®ä»£ã‚ã‚Šã«git hooksã§
\.git/hooks/pre-push

    HARBOR_DOMAIN=localhost:9999
    PROJECT_NAME=umedago
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    RES=`curl -XGET http://$HARBOR_DOMAIN/br?name=$PROJECT_NAME\&branch=$BRANCH`
    WORK=`echo ${RES} | jq -r '.work'`
    mkdir -p ${WORK}
    rsync -rv --exclude=.git . ${WORK}
    FLG=1
    curl -XPOST -d "payload={\"name\":\"$PROJECT_NAME\", \"branch\":\"$BRANCH\"}" http://$HARBOR_DOMAIN/up
    while [ $FLG == 1 ]
    do
    	sleep 1
    	RES=`curl -XGET http://$HARBOR_DOMAIN/br?name=$PROJECT_NAME\&branch=$BRANCH`
    	if [ $? == 0 ]; then
    		STATE=`echo $RES | jq -r '.state'`
    		if [ "$STATE" == "2" ]; then
    			FLG=2
    		fi
    	fi
    done

* æº–å‚™ã¨è§£èª¬

ãƒ‡ãƒ—ãƒ­ã‚¤ã€œã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã¾ã§ã®æµã‚Œ

- ã‚«ãƒ¬ãƒ³ãƒˆãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
- harborã«ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’å•ã„åˆã‚ã›
- ãƒ‡ãƒ—ãƒ­ã‚¤
- harborã«ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‚’å‘½ãšã‚‹
- harborã«ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãŸã‹ã©ã†ã‹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°

* Demo

- harborèµ·å‹•
- harborã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç™»éŒ²
- umedagoãƒ¬ãƒã‚¸ãƒˆãƒªã®masterã‚’push
- å‹•ä½œç¢ºèª
- umedagoãƒ¬ãƒã‚¸ãƒˆãƒªã®featureãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—push
- å‹•ä½œç¢ºèª
- ğŸ‰

* libcompose

* libcompose:æ¦‚è¦

[[https://github.com/docker/libcompose][docker/libcompose: An experimental go library providing Compose-like functionality]]

- docker-composeãŒä½¿ã£ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
- Goè£½ãªã®ã§importã™ã‚Œã°ä½¿ãˆã‚‹
- ã—ã‹ã‚‚ç°¡å˜

* libcompose:ã‚µãƒ³ãƒ—ãƒ«

READMEã‹ã‚‰æŠœç²‹

.code libcompose.sample.go /^func main/,/^}/

* libcompose:ä¸å¤ªè©±

- [[https://github.com/docker/libcompose/issues/208][Support .env files for environment variables Â· Issue #208 Â· docker/libcompose]]
- docker-compose1.7ã‹ã‚‰å¯¾å¿œã—ã¦ã„ã‚‹.envã®èª­ã¿è¾¼ã¿ã¯ã¾ã éå¯¾å¿œ
- å€‹äººçš„ã«ã¯libcomposeåˆ©ç”¨è€…ãŒã€Œã‚ã‚Œã°èª­ã‚€ã€ã‚’å®Ÿè£…ã™ã‚‹æ–¹ãŒè‰¯ã„ã‹ã¨æ€ã†

* ãŠã¾ã‘

[[https://github.com/dev-cloverlab/carpenter][dev-cloverlab/carpenter: Carpenter is a tool to manage DB schema and data]]

ç´¹ä»‹è³‡æ–™

- [[http://go-talks.appspot.com/github.com/hatajoe/kug2/20161127/index.slide#1][dev-cloverlab/carpenter]]
- [[http://qiita.com/Hatajoe/items/256514d9f76dea04ef49][DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ä½œã£ãŸè©± - Qiita]]
- [[http://qiita.com/nownabe/items/1acce9f6b9f14f74c965][Goè£½ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã¾ã¨ã‚ - Qiita]]

MySQLã®ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®æ§‹é€ ã¨ãƒ‡ãƒ¼ã‚¿å·®åˆ†ã®ãƒ‘ãƒƒãƒã‚’å……ã¦ã‚‹ãƒ„ãƒ¼ãƒ«
harborã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨DBã‚‚æ§‹ç¯‰å‡ºæ¥ã‚‹

